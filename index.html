<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TIFFYAI Claim Portal</title>

  <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
  <script src="lib/web3-provider.js"></script>
  <script src="https://unpkg.com/web3modal@1.9.12/dist/index.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      width: 100%; height: 100%;
      font-family: 'Segoe UI', sans-serif;
      background: black;
      color: cyan;
      overflow: hidden;
    }
    #intro, #main {
      position: absolute; left: 0; top: 0;
      width: 100%; height: 100%;
      display: flex; flex-direction: column;
      justify-content: center; align-items: center;
    }
    #intro {
      background: url('Token.png') center/cover no-repeat;
      text-align: center;
    }
    #typingText {
      margin-top: 30px;
      font-size: 1.5rem;
      max-width: 80%;
      line-height: 1.4;
    }
    #connectBtn {
      margin-top: 40px;
      padding: 14px 28px;
      font-size: 1rem;
      border: none;
      background: #00ffe7;
      color: black;
      border-radius: 8px;
      cursor: pointer;
    }
    #main {
      display: none;
      background: url('TiffyAI -Treasury.jpg') center/cover no-repeat;
    }
    .glass {
      background: rgba(0,0,0,0.4);
      border: 2px solid cyan;
      padding: 40px;
      border-radius: 20px;
      backdrop-filter: blur(10px);
      text-align: center;
      box-shadow: 0 0 20px cyan;
    }
    #claimButton {
      width: 120px; height: 120px;
      background: url('TiffyAI-Token.png') center/contain no-repeat;
      border: none; border-radius: 50%;
      cursor: pointer;
      animation: pulse 2s infinite;
      box-shadow: 0 0 20px lime;
    }
    #claimButton.cooldown { box-shadow: 0 0 20px red; animation: none; }
    @keyframes pulse {
      0%,100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    .info, .price {
      margin-top: 16px; font-size: 1.1rem;
    }
    .price { color: gold; }
    a#sourcifyLink {
      color: #00ffff; text-decoration: none;
      margin-top: 16px;
      font-size: 0.9rem;
    }
    a#sourcifyLink:hover { text-decoration: underline; }
  </style>
</head>
<body>

  <div id="intro">
    <div id="typingText"></div>
    <button id="connectBtn">ðŸ”Œ Connect Wallet</button>
  </div>

  <div id="main">
    <div class="glass">
      <button id="claimButton" title="Claim 1 TIFFY" disabled></button>
      <div class="info" id="cooldownInfo">Checking eligibility...</div>
      <div class="info" id="keyInfo">ðŸ”¹ Blue Keys: 0</div>
      <div class="price" id="priceInfo">Fetching TIFFY Price...</div>
      <a href="https://repo.sourcify.dev/56/0xE488253DD6B4D31431142F1b7601C96f24Fb7dd5" id="sourcifyLink" target="_blank">ðŸ§ª Verified on Sourcify</a>
    </div>
  </div>

<script>
  const CONTRACT = "0xE488253DD6B4D31431142F1b7601C96f24Fb7dd5";
  const ABI = [
    // claim, lastClaimed, isFeeExempt
    { "inputs": [], "name": "claim", "outputs": [], "stateMutability": "payable", "type": "function" },
    { "inputs": [{ "internalType": "address","name":"","type":"address" }], "name": "lastClaimed","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function" },
    { "inputs":[{"internalType":"address","name":"","type":"address"}],"name":"isFeeExempt","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function" }
  ];

  let web3, provider, contract, account;

  async function typeIntro() {
    const text = "Welcome to the TiffyAI Claim Portal\nCollect 1 TIFFY token daily â€” just connect your wallet below.";
    const el = document.getElementById("typingText");
    let i = 0;
    return new Promise(res => {
      const loop = () => {
        if (i < text.length) {
          el.textContent += text.charAt(i++);
          setTimeout(loop, 40);
        } else res();
      };
      loop();
    });
  }

  async function connectWallet() {
    const opts = {
      walletconnect: {
        package: window.WalletConnectProvider.default,
        options: { projectId: "bf40c7dcdb05f06f2769573103007576", chains: [56], rpcMap:{56:"https://bsc-dataseed.binance.org/"}, showQrModal: true }
      }
    };
    const modal = new Web3Modal.default({ cacheProvider: false, providerOptions: opts });
    provider = await modal.connect();
    await provider.enable?.();
    web3 = new Web3(provider);
    account = (await web3.eth.getAccounts())[0];

    const chain = await web3.eth.getChainId();
    if (chain !== 56) {
      try {
        await provider.request({ method: 'wallet_switchEthereumChain', params:[{ chainId:'0x38' }] });
      } catch(e1){
        try {
          await provider.request({ method:'wallet_addEthereumChain', params:[{
            chainId:'0x38', chainName:'BNB Smart Chain',
            rpcUrls:['https://bsc-dataseed.binance.org/'],
            nativeCurrency:{name:'BNB',symbol:'BNB',decimals:18},
            blockExplorerUrls:['https://bscscan.com']
          }]});
        } catch(e2){
          alert("Switch to BNB Smart Chain manually, brother.");
          throw e2;
        }
      }
    }

    contract = new web3.eth.Contract(ABI, CONTRACT);
    if (!contract.methods?.claim) {
      console.warn("Retrying contract initialization...");
      await new Promise(r=>setTimeout(r, 500));
      contract = new web3.eth.Contract(ABI, CONTRACT);
    }

    document.getElementById("intro").style.display = "none";
    document.getElementById("main").style.display = "flex";

    await initClaimUI();
  }

  async function initClaimUI() {
    fetchPrice();
    document.getElementById("claimButton").disabled = false;
    document.getElementById("claimButton").addEventListener("click", claimTiffy);
    setInterval(fetchPrice, 60000);
    setInterval(checkCooldown, 30000);
    checkCooldown();
    updateKeyDisplay();
  }

  async function checkCooldown() {
    try {
      const last = await contract.methods.lastClaimed(account).call();
      const rem = parseInt(last) + 86400 - Math.floor(Date.now()/1000);
      const btn = document.getElementById("claimButton");
      const info = document.getElementById("cooldownInfo");
      if (rem <=0) {
        info.textContent="âœ… Claim available!"; btn.classList.remove("cooldown"); btn.disabled=false;
      } else {
        const h=~~(rem/3600), m=~~((rem%3600)/60), s=rem%60;
        info.textContent=`â³ Next claim: ${h}h ${m}m ${s}s`;
        btn.disabled=true; btn.classList.add("cooldown");
      }
    } catch(e){
      console.error(e);
      document.getElementById("cooldownInfo").textContent="Error loading cooldown";
    }
  }

  async function claimTiffy() {
    try {
      const exempt = await contract.methods.isFeeExempt(account).call();
      const opts = exempt ? {from:account} : { from:account, value:web3.utils.toWei("0.00086","ether") };
      await contract.methods.claim().send(opts);
      const k = (parseInt(localStorage.getItem("tiffyBlueKeys"))||0)+1;
      localStorage.setItem("tiffyBlueKeys", k);
      updateKeyDisplay();
      alert("âœ… Claimed & Blue Key earned!");
      checkCooldown();
    } catch(e){
      console.error(e);
      alert("âŒ Claim failed: "+(e.message||"Try again"));
    }
  }

  function updateKeyDisplay() {
    document.getElementById("keyInfo").textContent = `ðŸ”¹ Blue Keys: ${parseInt(localStorage.getItem("tiffyBlueKeys"))||0}`;
  }

  async function fetchPrice() {
    try {
      const res = await fetch("/TIFFY-Market-Value/price.json");
      const j = await res.json();
      document.getElementById("priceInfo").textContent = `ðŸ’° ${j.tiffyToUSD}â€¯USD / ${j.tiffyToWBNB}â€¯WBNB`;
    } catch (e){
      console.error("Price error:", e);
      document.getElementById("priceInfo").textContent = "Price unavailable";
    }
  }

  window.addEventListener("load", async () => {
    await typeIntro();
    document.getElementById("connectBtn").onclick = connectWallet;
  });
</script>
</body>
</html>
