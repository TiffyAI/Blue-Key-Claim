<script>
  const contractAddress = "0x6df97Ec32401e23dEDB2E6cAF3035155890DC237";
  const claimABI = [
    { "inputs": [], "name": "claim", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
    { "inputs": [{ "internalType": "address", "name": "", "type": "address" }],
      "name": "lastClaimed", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
      "stateMutability": "view", "type": "function"
    }
  ];

  const web3Modal = new window.Web3Modal.default({
    cacheProvider: false,
    providerOptions: {
      walletconnect: {
        package: window.WalletConnectProvider.default,
        options: {
          rpc: { 97: "https://data-seed-prebsc-1-s1.binance.org:8545/" },
          chainId: 97
        }
      }
    }
  });

  let web3, provider, user, contract;

  async function connectWalletAndClaim() {
    try {
      provider = await web3Modal.connect();
      web3 = new Web3(provider);
      const networkId = await web3.eth.net.getId();
      if (networkId !== 97) return alert("Switch to BSC Testnet");

      const accounts = await web3.eth.getAccounts();
      user = accounts[0];
      contract = new web3.eth.Contract(claimABI, contractAddress);

      const lastClaimed = await contract.methods.lastClaimed(user).call();
      const now = Math.floor(Date.now() / 1000);

      if (now >= parseInt(lastClaimed) + 86400) {
        await contract.methods.claim().send({ from: user });
        triggerKeysEffect();
        showClaimSuccess();
        let keys = parseInt(localStorage.getItem('tiffyBlueKeys') || '0') + 1;
        localStorage.setItem('tiffyBlueKeys', keys);
        updateKeyCounter(keys);

        if (keys >= 10) {
          setTimeout(() => window.location.href = "/treasure", 3000);
        } else {
          setTimeout(() => window.location.href = "/TiffyAI-Users/", 3000);
        }
      } else {
        alert("Claim cooldown still active. Redirecting you to engage with TiffyAI.");
        window.location.href = "/TiffyAI-Users/";
      }
    } catch (err) {
      alert("Transaction failed: " + (err.message || err));
    }
  }

  function triggerKeysEffect() {
    const keys = document.getElementById("keysEffect");
    keys.style.animation = "none";
    void keys.offsetWidth;
    keys.style.animation = "growFadeOut 2.8s ease-out forwards";
  }

  function showClaimSuccess() {
    document.getElementById("successOverlay").style.display = "flex";
  }

  function updateKeyCounter(keys = null) {
    const count = keys !== null ? keys : parseInt(localStorage.getItem('tiffyBlueKeys') || '0');
    document.getElementById("blueKeyCounter").innerText =
      `You've claimed ${count}/10 Blue Keys to Unlock Your Special Treasure Chest`;
    if (count >= 10) {
      document.getElementById("modalOverlay").style.display = "flex";
    }
  }

  async function updateCooldown() {
    if (!contract || !user) return;
    try {
      const lastClaimed = await contract.methods.lastClaimed(user).call();
      const nextClaim = parseInt(lastClaimed) + 86400;
      const now = Math.floor(Date.now() / 1000);
      const remaining = nextClaim - now;
      const timer = document.getElementById("cooldownTimer");
      const button = document.getElementById("claimButton");

      if (remaining <= 0) {
        timer.innerText = "Claim Available Now!";
        button.classList.remove("cooldown");
      } else {
        button.classList.add("cooldown");
        const h = Math.floor(remaining / 3600);
        const m = Math.floor((remaining % 3600) / 60);
        const s = remaining % 60;
        timer.innerText = `Next claim in: ${h}h ${m}m ${s}s`;
      }
    } catch (e) {
      console.warn("Cooldown error:", e);
    }
  }

  function redirectToTreasure() {
    window.location.href = "/treasure";
  }

  function redirectToUsers() {
    window.location.href = "/TiffyAI-Users/";
  }

  document.getElementById("claimButton").onclick = connectWalletAndClaim;
  setInterval(updateCooldown, 1000);
  updateKeyCounter();
</script>
